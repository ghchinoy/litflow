<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LitFlow - Inspector Designer</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: 'Roboto', sans-serif;
      overflow: hidden;
      background-color: #f5f5f5;
    }

    .designer-container {
      display: grid;
      grid-template-columns: 240px 1fr 400px;
      height: 100vh;
      width: 100vw;
    }

    .palette-pane {
      background-color: var(--md-sys-color-surface);
      border-right: 1px solid #333;
      z-index: 100;
    }

    .canvas-pane {
      position: relative;
      background-color: #fff;
    }

    .inspector-pane {
      background-color: #1e1e1e;
      color: #d4d4d4;
      display: flex;
      flex-direction: column;
      border-left: 1px solid #333;
      box-shadow: -2px 0 10px rgba(0,0,0,0.2);
      z-index: 100;
    }

    .inspector-header {
      padding: 12px 16px;
      background-color: #252526;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .inspector-header h2 {
      margin: 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #969696;
    }

    .inspector-body {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    #json-editor {
      width: 100%;
      height: 100%;
      background: transparent;
      color: #9cdcfe;
      border: none;
      padding: 16px;
      box-sizing: border-box;
      font-family: 'Fira Code', 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.5;
      resize: none;
      outline: none;
    }

    .inspector-footer {
      padding: 12px 16px;
      background-color: #252526;
      border-top: 1px solid #333;
      display: flex;
      gap: 8px;
    }

    button {
      background-color: #0e639c;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 2px;
      cursor: pointer;
      font-size: 12px;
    }

    button:hover {
      background-color: #1177bb;
    }

    button.secondary {
      background-color: #3a3d41;
    }

    button.secondary:hover {
      background-color: #45494e;
    }

    .status-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 22px;
      background-color: #007acc;
      color: white;
      font-size: 11px;
      display: flex;
      align-items: center;
      padding: 0 12px;
      z-index: 1000;
    }

    /* Overlay styles for Copy feedback */
    .toast {
      position: fixed;
      bottom: 40px;
      right: 420px;
      background: #333;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .toast.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="designer-container">
    <div class="palette-pane">
      <lit-sidebar id="sidebar"></lit-sidebar>
    </div>
    <div class="canvas-pane">
      <lit-flow 
        id="flow" 
        show-controls 
        show-minimap 
        show-grid
        pan-on-drag
        selection-mode="select"
      ></lit-flow>
    </div>
    
    <div class="inspector-pane">
      <div class="inspector-header">
        <h2>Graph Inspector</h2>
        <span id="sync-indicator" style="font-size: 10px; color: #6a9955;">LIVE SYNC ON</span>
      </div>
      <div class="inspector-body">
        <textarea id="json-editor" spellcheck="false"></textarea>
      </div>
      <div class="inspector-footer">
        <button id="copy-btn">Copy JSON</button>
        <button id="apply-btn" class="secondary">Apply Changes</button>
        <button id="format-btn" class="secondary">Format</button>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px; color: #969696;">
          <input type="checkbox" id="auto-apply"> Auto-apply
        </label>
      </div>
    </div>
  </div>

  <div class="status-bar">
    LitFlow Designer | nodes: <span id="node-count">0</span> | edges: <span id="edge-count">0</span>
  </div>

  <div id="toast" class="toast">Copied to clipboard!</div>

  <script type="module">
    import '../../src/index.ts';

    const flow = document.getElementById('flow');
    const sidebar = document.getElementById('sidebar');
    const editor = document.getElementById('json-editor');
    const nodeCount = document.getElementById('node-count');

    // Update sidebar with standard types
    sidebar.nodeTypes = [
      { type: 'input', label: 'Input Node' },
      { type: 'default', label: 'Default Node' },
      { type: 'output', label: 'Output Node' },
    ];

    const autoApply = document.getElementById('auto-apply');

    const initialNodes = [
      { id: '1', type: 'input', data: { label: 'Input Node' }, position: { x: 50, y: 50 } },
      { id: '2', data: { label: 'Default Node' }, position: { x: 50, y: 150 } },
      { id: '3', type: 'output', data: { label: 'Output Node' }, position: { x: 50, y: 250 } },
    ];

    const initialEdges = [
      { id: 'e1-2', source: '1', target: '2', markerEnd: 'arrow' },
      { id: 'e2-3', source: '2', target: '3', markerEnd: 'arrow' },
    ];

    // Initialize flow
    flow.nodes = initialNodes;
    flow.edges = initialEdges;

    function updateInspector(nodes, edges) {
      const graph = {
        nodes: nodes.map(({ id, type, position, data }) => ({ id, type, position, data })),
        edges: edges.map(({ id, source, target, sourceHandle, targetHandle, type, label, markerEnd }) => ({
           id, source, target, sourceHandle, targetHandle, type, label, markerEnd 
        }))
      };
      
      // Only update editor if it doesn't have focus (to prevent cursor jumping during two-way bind)
      if (document.activeElement !== editor) {
        editor.value = JSON.stringify(graph, null, 2);
      }
      
      nodeCount.textContent = nodes.length;
      edgeCount.textContent = edges.length;
    }

    // Live Sync from Flow to Inspector
    flow.addEventListener('change', (e) => {
      const { nodes, edges } = e.detail;
      updateInspector(nodes, edges);
    });

    function applyChanges() {
      try {
        const graph = JSON.parse(editor.value);
        if (graph.nodes) flow.nodes = graph.nodes;
        if (graph.edges) flow.edges = graph.edges;
      } catch (err) {
        // Silently fail for auto-apply to allow typing
        if (document.activeElement !== editor) {
          alert('Invalid JSON: ' + err.message);
        }
      }
    }

    // Initial update
    updateInspector(flow.nodes, flow.edges);

    // Manual Apply from Inspector to Flow
    applyBtn.addEventListener('click', applyChanges);

    // Format JSON
    formatBtn.addEventListener('click', () => {
      try {
        const graph = JSON.parse(editor.value);
        editor.value = JSON.stringify(graph, null, 2);
      } catch (err) {}
    });

    // Copy to Clipboard
    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(editor.value).then(() => {
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
      });
    });

    // Auto-apply on typing
    let typingTimer;
    editor.addEventListener('input', () => {
      if (!autoApply.checked) return;
      clearTimeout(typingTimer);
      typingTimer = setTimeout(applyChanges, 300);
    });
  </script>
</body>
</html>
