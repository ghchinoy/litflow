name: Deploy Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'docs/**'
      - 'package.json'
      - 'pnpm-lock.yaml'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v4
        with:
          version: 10
          
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          
      - name: Install dependencies (root)
        run: pnpm install
        
      - name: Build Library
        run: pnpm build
        
      - name: Install dependencies (docs)
        run: cd docs && pnpm install
        
      - name: Prepare Docs Public Assets
        run: |
          mkdir -p docs/src/public
          cp dist/litflow.js docs/src/public/
          cp dist/theme.js docs/src/public/
          
      - name: Build Eleventy
        run: cd docs && pnpm build
        
      - name: Copy and Fix Examples
        run: |
          mkdir -p docs/_site/examples
          cp -r examples/* docs/_site/examples/
          # Fix imports in all index.html files in examples
          find docs/_site/examples -name "index.html" -exec sed -i "s|import '../../src/index.ts';|import '/public/litflow.js';|g" {} +
          find docs/_site/examples -name "index.html" -exec sed -i "s|import '../src/index.ts';|import '/public/litflow.js';|g" {} +
          find docs/_site/examples -name "index.html" -exec sed -i "s|import '../../../src/index.ts';|import '/public/litflow.js';|g" {} +
          # Add import map to examples to handle dependencies
          find docs/_site/examples -name "index.html" -exec sed -i '/<head>/a \    <script type="importmap">{ "imports": { "lit": "https://esm.sh/lit?bundle", "lit/": "https://esm.sh/lit/", "@lit-labs/signals": "https://esm.sh/@lit-labs/signals", "@xyflow/system": "https://esm.sh/@xyflow/system", "d3-drag": "https://esm.sh/d3-drag", "d3-interpolate": "https://esm.sh/d3-interpolate", "d3-selection": "https://esm.sh/d3-selection", "d3-zoom": "https://esm.sh/d3-zoom" } }</script>' {} +
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs/_site'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
